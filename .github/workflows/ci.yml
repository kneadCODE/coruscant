# CI Pipeline for Coruscant Project
#
# This workflow implements a streamlined CI/CD pipeline for a Go monorepo following
# Clean Architecture and Domain-Driven Design principles.
#
# Pipeline Phases:
# Phase 1: Parallel Testing & Quality Gates (tests, lint, govulncheck)
# Phase 2: Quality Analysis (SonarCloud with coverage)
# Phase 3: Docker Build (after all tests pass)
# Phase 4: Docker Push (main only, after all gates pass)
# Phase 5: CI Status (overall pipeline result)
#
# Security Architecture:
# - Security scanning handled by dedicated trivy.yml workflow (GHAS reporting)
# - CI focuses on build/test/push without security gating
# - GitHub Security tab manages security findings with override capability
# - Supply chain security with SBOM attestations
#
# Note: This follows Option B (GHAS flexibility) security model

name: "CI Pipeline"

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions: {}

# Global environment variables
env:
  CONTAINER_REGISTRY: ghcr.io # GitHub Container Registry
  REPOSITORY_NAME: ${{ github.repository }} # Full repository name (org/repo)

jobs:
  # =============================================================================
  # DETECT CHANGED FILES FOR CONDITIONAL EXECUTION
  # =============================================================================
  detect-changes:
    name: "Detect Changed Files"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Detect changed file types
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            code:
              - 'contracts/**'
              - 'shared/**'
              - 'systems/**'
              - '.golangci.yml'
              - '.dockerignore'
              - 'docker-compose.yaml'
              - 'go.work'
              - 'go.work.sum'
              - '.github/workflows/ci.yml'
              - '.github/workflows/codeql.yml'

  # =============================================================================
  # PHASE 1: PARALLEL SECURITY GATES & TESTING
  # =============================================================================

  # Unit tests with coverage for Go modules
  test:
    name: "Test (Unit ${{ matrix.module }})"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    permissions:
      contents: read # Read repository contents
      actions: write # Upload test artifacts
    strategy:
      matrix:
        include:
          - module: "golib"
            path: "./shared/golib"
          - module: "kyber"
            path: "./systems/kyber"
            gen-mocks: true
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go workspace
        uses: ./.github/actions/setup-go-workspace

      - name: Generate mocks
        if: matrix.gen-mocks == true
        run: docker compose run --rm -w /app/${{ matrix.path }} mockery

      - name: Start observability stack and PostgreSQL for tests
        run: |
          # Start observability stack and PostgreSQL needed for tests
          docker compose up -d alloy tempo loki mimir postgres
          # Wait for services to be ready
          sleep 10

      - name: Run tests with coverage
        working-directory: ${{ matrix.path }}
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: localhost:4317
          OTEL_EXPORTER_OTLP_INSECURE: "true"
          OTEL_SERVICE_NAME: ci-test
          OTEL_RESOURCE_ATTRIBUTES: "service.namespace=${{ matrix.module }},service.version=v1.0.0,deployment.environment=dev"
          OTEL_SERVICE_VERSION: ci
          PG_HOST: localhost
          PG_PORT: 5432
          PG_DATABASE: postgres
          PG_USERNAME: coruscant
          PG_PASSWORD: trust
          PG_SSL_MODE: disable
        run: |
          go test -v -race -coverprofile=coverage.out -failfast -timeout 5m ./...

      - name: Cleanup observability stack and PostgreSQL
        if: always()
        run: |
          docker compose down -v

      # Upload coverage artifacts for SonarCloud
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: coverage-${{ matrix.module }}
          path: ${{ matrix.path }}/coverage.out
          retention-days: 1

  # Code quality linting
  quality-lint:
    name: "Quality (Lint ${{ matrix.module }})"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    permissions:
      contents: read # Read repository contents
    strategy:
      matrix:
        include:
          - module: "golib"
            path: "./shared/golib"
          - module: "kyber"
            path: "./systems/kyber"
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go workspace
        uses: ./.github/actions/setup-go-workspace

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          working-directory: ${{ matrix.path }}
          version: v2.4.0

  # SCA - Software Composition Analysis (Go vulnerabilities)
  security-sca-govulncheck:
    name: "Security SCA (govulncheck ${{ matrix.module }})"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    permissions:
      contents: read # Read repository contents
    strategy:
      matrix:
        include:
          - module: "golib"
            path: "./shared/golib"
          - module: "kyber"
            path: "./systems/kyber"
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go workspace
        uses: ./.github/actions/setup-go-workspace

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@v1.1.4

      - name: Run govulncheck
        working-directory: ${{ matrix.path }}
        run: govulncheck ./...

  # =============================================================================
  # PHASE 2: QUALITY ANALYSIS (needs coverage from tests)
  # =============================================================================

  quality-sonar:
    name: "SonarCloud (${{ matrix.module }})"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect-changes, test] # Needs coverage artifacts
    if: needs.detect-changes.outputs.code == 'true'
    permissions:
      contents: read # Read repository contents
      actions: read # Download test coverage artifacts
    strategy:
      matrix:
        include:
          - module: "golib"
            path: "./shared/golib"
            sonar-token-secret: SONAR_TOKEN_GOLIB
          - module: "kyber"
            path: "./systems/kyber"
            sonar-token-secret: SONAR_TOKEN_KYBER
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # Full history for SonarCloud

      - name: Download coverage artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: coverage-${{ matrix.module }}
          path: ${{ matrix.path }}

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets[matrix.sonar-token-secret] }}
        with:
          projectBaseDir: ${{ matrix.path }}

  # =============================================================================
  # PHASE 3: DOCKER BUILD (after all security gates pass)
  # =============================================================================

  docker-build:
    name: "Build (Docker ${{ matrix.system }}/${{ matrix.image }})"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    permissions:
      contents: read # Read repository contents
      actions: write # Upload docker image artifacts
    strategy:
      matrix:
        include:
          - system: "kyber"
            image: "go-services"
            dockerfile: "shared/docker/go-services.Dockerfile"
            build-args: |
              SYSTEM=kyber
              RUNTIME_IMAGE_TAG=nonroot
          - system: "kyber"
            image: "db-migrations"
            dockerfile: "shared/docker/golang-migrate.Dockerfile"
            build-args: |
              SYSTEM=kyber
              RUNTIME_IMAGE_TAG=nonroot
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Generate metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.CONTAINER_REGISTRY }}/${{ env.REPOSITORY_NAME }}/${{ matrix.system }}/${{ matrix.image }}
          tags: |
            type=sha

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: false # Build only, don't push yet
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: ${{ matrix.build-args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker

      # Export image as tar file for sharing with other jobs
      - name: Export Docker image
        run: |
          docker save ${{ steps.meta.outputs.tags }} -o ${{ matrix.system }}-${{ matrix.image }}-${{ github.sha }}.tar

      # Upload image artifact for security scanning and attestation jobs
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: docker-image-${{ matrix.system }}-${{ matrix.image }}-${{ github.sha }}
          path: ${{ matrix.system }}-${{ matrix.image }}-${{ github.sha }}.tar
          retention-days: 1 # Clean up after 1 day

  docker-push:
    name: "Push (Docker ${{ matrix.system }}/${{ matrix.image }})"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [quality-lint, security-sca-govulncheck, quality-sonar, docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read # Read repository contents
      packages: write # Push to GitHub Container Registry
      actions: read # Download docker image artifacts
      id-token: write # For keyless signing with Cosign
      attestations: write # For GitHub native attestations
    strategy:
      matrix:
        include:
          - system: "kyber"
            image: "go-services"
            dockerfile: "shared/docker/go-services.Dockerfile"
            build-args: |
              SYSTEM=kyber
              RUNTIME_IMAGE_TAG=nonroot
          - system: "kyber"
            image: "db-migrations"
            dockerfile: "shared/docker/golang-migrate.Dockerfile"
            build-args: |
              SYSTEM=kyber
              RUNTIME_IMAGE_TAG=nonroot
      fail-fast: false

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.CONTAINER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.CONTAINER_REGISTRY }}/${{ env.REPOSITORY_NAME }}/${{ matrix.system }}/${{ matrix.image }}
          tags: |
            type=sha

      # Download pre-built image artifact from docker-build job
      - name: Download Docker image artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: docker-image-${{ matrix.system }}-${{ matrix.image }}-${{ github.sha }}

      # Load and push image from artifact
      - name: Load and push Docker image
        id: build
        run: |
          # Load image from artifact
          docker load -i ${{ matrix.system }}-${{ matrix.image }}-${{ github.sha }}.tar

          # Push to registry
          echo "Pushing image to registry: ${{ steps.meta.outputs.tags }}"
          docker push ${{ steps.meta.outputs.tags }}

          # Extract digest for signing
          pushed_digest=$(docker inspect ${{ steps.meta.outputs.tags }} --format='{{index .RepoDigests 0}}' | cut -d'@' -f2)
          echo "digest=$pushed_digest" >> $GITHUB_OUTPUT
          echo "Pushed image with digest: $pushed_digest"

      # Generate SBOM for attestation
      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0.21.1
        with:
          image: ${{ steps.meta.outputs.tags }}
          format: spdx-json
          output-file: sbom.spdx.json

      # Generate GitHub SBOM Attestation (replaces Cosign attestation)
      - name: Generate GitHub Attestation for SBOM
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-name: ${{ steps.meta.outputs.tags }}
          subject-digest: ${{ steps.build.outputs.digest }}
          sbom-path: sbom.spdx.json

  # =============================================================================
  # PHASE 6: CI STATUS (overall pipeline result)
  # =============================================================================

  ci-status:
    name: "CI Status"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      [
        detect-changes,
        test,
        quality-lint,
        security-sca-govulncheck,
        quality-sonar,
        docker-push,
      ]
    if: always() # Run for both PRs (docker-push skipped) and main (docker-push runs)

    steps:
      - name: Check CI pipeline results
        run: |
          echo "CI Pipeline Results:"
          echo "  detect-changes: ${{ needs.detect-changes.result }}"
          echo "  test: ${{ needs.test.result }}"
          echo "  quality-lint: ${{ needs.quality-lint.result }}"
          echo "  security-sca-govulncheck: ${{ needs.security-sca-govulncheck.result }}"
          echo "  quality-sonar: ${{ needs.quality-sonar.result }}"
          echo "  docker-push: ${{ needs.docker-push.result }}"

          # Fail if any required job failed (not skipped)
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]] || \
             [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "::error::One or more CI jobs failed or were cancelled"
            exit 1
          fi

          echo "âœ… CI pipeline passed (skipped jobs are OK for non-code changes)"
