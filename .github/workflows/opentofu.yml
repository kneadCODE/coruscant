# Infrastructure as Code Pipeline for Coruscant Project
#
# This workflow implements security-first OpenTofu practices with:
# - Multi-directory workspace isolation (one workspace per PR enforcement)
# - Comprehensive security scanning (Trivy IaC)
# - Azure OIDC authentication (no long-lived secrets)
# - Two-credential strategy (read-only for PRs, admin for main branch)
# - GitOps approval model (PR approval = infrastructure approval)
# - Plan artifact persistence and verification
#
# Why OpenTofu?
# - True open-source (MPL 2.0 license vs Terraform's restrictive BSL)
# - Native state encryption feature
# - Linux Foundation backed, community-driven
# - 100% compatible drop-in replacement for Terraform
# - No vendor lock-in
#
# Workspace Strategy:
# - Each directory under azure/tf/platform/* and azure/tf/landingzone/* is an independent workspace
# - PRs can only modify one workspace at a time (enforced)
# - Each workspace maintains separate state files
#
# Security Model:
# - Read-only credentials (repository secrets): PRs can plan
# - Admin credentials (environment secrets): Main branch can plan and apply
# - Environment 'azure-tf-plan' for PR plans (read-only)
# - Environment 'azure-tf-apply' for main branch plans and applies (admin)
# - Malicious branches cannot access admin credentials
#
# Approval Model (GitOps):
# - PR review = infrastructure approval (reviewers examine plan output)
# - Apply runs automatically after merge to main using plan artifact from plan job
# - Deletions handled same as additions (remove from .tf files, not via destroy)
#
# Pipeline Phases:
# Phase 1: Validation (all branches with terraform changes)
# Phase 2: Plan Generation (all branches, read-only for PRs, admin for main, saves plan artifact)
# Phase 3: Apply (main branch push only, uses saved plan artifact from Phase 2)
#
# Plan Artifact Strategy:
# - Plan job saves tfplan artifact (retention: 5 days)
# - Apply job downloads and uses saved plan artifact
# - Ensures what was reviewed in PR is exactly what gets applied
#
# Note: Drift detection runs in separate workflow (opentofu-scheduled.yml)

name: "OpenTofu"

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions: {}

env:
  TOFU_VERSION: "1.11.2"
  ARM_USE_OIDC: "true"

jobs:
  # =============================================================================
  # DETECT CHANGED FILES FOR CONDITIONAL EXECUTION
  # =============================================================================
  detect-changes:
    name: "Detect Changed Files"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    outputs:
      terraform: ${{ steps.filter.outputs.terraform }}
      terraform_files: ${{ steps.filter.outputs.terraform_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Detect changed file types
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          list-files: json
          filters: |
            terraform:
              - 'azure/tf/platform/**/*.tf'
              - 'azure/tf/landingzone/**/*.tf'
              - '.github/workflows/opentofu.yml'

  # =============================================================================
  # DETECT CHANGED WORKSPACES & ENFORCE SINGLE-WORKSPACE RULE
  # =============================================================================
  detect-workspaces:
    name: "Detect Changed Workspaces"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect-changes]
    if: needs.detect-changes.outputs.terraform == 'true'
    permissions:
      contents: read
      pull-requests: write
    outputs:
      workspaces: ${{ steps.detect.outputs.workspaces }}
      workspace_count: ${{ steps.detect.outputs.count }}
      workspace_matrix: ${{ steps.detect.outputs.matrix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0 # Need full history to diff against base branch

      - name: Derive changed workspaces
        id: detect
        run: |
          set -euo pipefail

          # Determine base and head refs for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
          else
            # For push events, compare HEAD with previous commit
            BASE_REF="HEAD^"
            HEAD_REF="HEAD"
          fi

          echo "Comparing $BASE_REF...$HEAD_REF"

          # Get list of changed Terraform files (A=added, M=modified, R=renamed)
          # Explicitly exclude D=deleted files to avoid processing deleted workspaces
          # Only look at workspace directories, not workflow files
          CHANGED_FILES=$(git diff --name-only --diff-filter=AMR "$BASE_REF" "$HEAD_REF" -- \
            'azure/tf/platform/**/*.tf' 'azure/tf/landingzone/**/*.tf' || echo "")

          # Extract unique workspace names from file paths (format: platform/management/logs or landingzone/edge)
          WORKSPACES=$(echo "$CHANGED_FILES" | \
            grep -E '^azure/tf/(platform|landingzone)/' | \
            sed -E 's|^azure/tf/((platform\|landingzone)/[^/]+(/[^/]+)?)(/.*)?$|\1|' | \
            sort -u || echo "")

          # Count workspaces
          if [ -z "$WORKSPACES" ]; then
            COUNT=0
            LIST=""
            ARRAY="[]"
          else
            COUNT=$(echo "$WORKSPACES" | wc -l | tr -d ' ')
            LIST=$(echo "$WORKSPACES" | paste -sd "," -)
            ARRAY=$(echo "$WORKSPACES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi

          echo "Detected workspaces: $LIST (count: $COUNT)"
          echo "workspaces=${LIST}" >> "$GITHUB_OUTPUT"
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
          echo "matrix={\"workspace\":${ARRAY}}" >> "$GITHUB_OUTPUT"

      - name: Enforce single workspace per PR
        if: github.event_name == 'pull_request' && steps.detect.outputs.count > 1
        run: |
          echo "::error::PR modifies multiple workspaces: $WORKSPACES"
          gh pr comment "$PR_NUMBER" --body "## ⚠️ Multiple Workspaces Detected

          This PR modifies **$WORKSPACE_COUNT** workspaces: \`$WORKSPACES\`

          Please split into one workspace per PR."
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WORKSPACES: ${{ steps.detect.outputs.workspaces }}
          WORKSPACE_COUNT: ${{ steps.detect.outputs.count }}

  # =============================================================================
  # PHASE 1: VALIDATION
  # =============================================================================
  validate:
    name: "Validate (${{ matrix.workspace }})"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-changes, detect-workspaces]
    if: ${{ !failure() && !cancelled() && needs.detect-changes.outputs.terraform == 'true' && needs.detect-workspaces.outputs.workspace_count > 0 }}
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix: ${{ fromJson(needs.detect-workspaces.outputs.workspace_matrix) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@e95ccdd20623115bfd7d47df14a3250d6066a9d0 # v1.0.7
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: OpenTofu Format Check
        working-directory: azure/tf/${{ matrix.workspace }}
        run: tofu fmt -check -recursive

      - name: OpenTofu Init
        working-directory: azure/tf/${{ matrix.workspace }}
        run: tofu init -backend=false

      - name: OpenTofu Validate
        working-directory: azure/tf/${{ matrix.workspace }}
        run: tofu validate

  # =============================================================================
  # PHASE 2: PLAN (All branches with terraform changes)
  # =============================================================================
  plan:
    name: "Plan (${{ matrix.workspace }})"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, detect-workspaces, validate]
    if: ${{ !failure() && !cancelled() && needs.detect-changes.outputs.terraform == 'true' && needs.detect-workspaces.outputs.workspace_count > 0 }}
    environment: ${{ github.event_name == 'pull_request' && 'azure-tf-plan' || 'azure-tf-apply' }}
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    strategy:
      matrix: ${{ fromJson(needs.detect-workspaces.outputs.workspace_matrix) }}
      fail-fast: false
    env:
      TF_VAR_entra_tenant_id: ${{ secrets.ARM_TENANT_ID }}
      TF_VAR_subscription_id_foundation: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}
      TF_VAR_subscription_id_mapping_json: ${{ secrets.ARM_SUBSCRIPTION_ID_MAPPING_JSON }}
      TF_VAR_storage_account_name_mapping_json: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME_MAPPING_JSON }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Mask sensitive values in logs
        uses: ./.github/actions/mask-azure-secrets
        with:
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id-foundation: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}
          tfstate-storage-account-name: ${{ secrets.ARM_TFSTATE_STORAGE_ACCOUNT_NAME }}
          subscription-id-mapping-json: ${{ secrets.ARM_SUBSCRIPTION_ID_MAPPING_JSON }}
          storage-account-name-mapping-json: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME_MAPPING_JSON }}

      - name: Azure Login via OIDC
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ github.event_name == 'pull_request' && secrets.ARM_CLIENT_ID_SP_GHA_TF_PLAN_GLOBAL || (startsWith(matrix.workspace, 'platform/') && secrets.ARM_CLIENT_ID_SP_GHA_TF_APPLY_PLATFORM || secrets.ARM_CLIENT_ID_SP_GHA_TF_APPLY_LANDINGZONE) }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@e95ccdd20623115bfd7d47df14a3250d6066a9d0 # v1.0.7
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: OpenTofu Init
        working-directory: azure/tf/${{ matrix.workspace }}
        run: tofu init ${{ github.event_name == 'pull_request' && '-lock=false' || '' }} -backend-config="storage_account_name=$TFSTATE_STORAGE_ACCOUNT"
        env:
          TFSTATE_STORAGE_ACCOUNT: ${{ secrets.ARM_TFSTATE_STORAGE_ACCOUNT_NAME }}

      - name: OpenTofu Plan
        id: plan
        working-directory: azure/tf/${{ matrix.workspace }}
        shell: bash
        run: |
          set -euo pipefail

          # Run plan and capture the detailed exit code safely.
          set +e
          tofu plan ${{ github.event_name == 'pull_request' && '-lock=false' || '' }} -out=tfplan -detailed-exitcode
          CODE=$?
          set -e

          echo "code=$CODE" >> "$GITHUB_OUTPUT"

          # Exit codes: 0 = no changes, 1 = error, 2 = changes present
          if [[ "$CODE" -eq 1 ]]; then
            echo "::error::OpenTofu plan failed"
            exit 1
          elif [[ "$CODE" -eq 2 ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Plan Artifact
        if: steps.plan.outputs.has_changes == 'true'
        uses: actions/upload-artifact@ea0eaec3dfd8a92a1ec3c75b1fb98c2beec9b2f9 # v4.6.0
        with:
          name: tfplan-${{ matrix.workspace }}
          path: azure/tf/${{ matrix.workspace }}/tfplan
          retention-days: 1
          if-no-files-found: error

      - name: Generate Plan Summary
        if: github.event_name == 'pull_request' && steps.plan.outputs.has_changes == 'true'
        working-directory: azure/tf/${{ matrix.workspace }}
        shell: bash
        run: |
          set -euo pipefail

          {
            echo "## OpenTofu Plan: $WORKSPACE"
            echo ""
            echo "\`\`\`"
            tofu show -no-color tfplan
            echo "\`\`\`"
          } > plan-summary.md
        env:
          WORKSPACE: ${{ matrix.workspace }}

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request' && steps.plan.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail

          # Find existing comment by this workflow for this workspace
          COMMENT_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            --jq ".[] | select(.user.login == \"github-actions[bot]\" and (.body | startswith(\"## OpenTofu Plan: $WORKSPACE\"))) | .id" \
            | head -n 1)

          PLAN_BODY=$(cat "azure/tf/$WORKSPACE/plan-summary.md")

          if [[ -n "$COMMENT_ID" ]]; then
            # Update existing comment
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
              -f body="$PLAN_BODY"
            echo "Updated existing comment ID: $COMMENT_ID for workspace: $WORKSPACE"
          else
            # Create new comment
            gh pr comment "$PR_NUMBER" --body-file "azure/tf/$WORKSPACE/plan-summary.md"
            echo "Created new comment for workspace: $WORKSPACE"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WORKSPACE: ${{ matrix.workspace }}

  # =============================================================================
  # PHASE 3: APPLY (Push to main only, uses plan from Phase 2)
  # =============================================================================
  apply:
    name: "Apply (${{ matrix.workspace }})"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [detect-changes, detect-workspaces, validate, plan]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      !failure() && !cancelled() &&
      needs.detect-changes.outputs.terraform == 'true' &&
      needs.detect-workspaces.outputs.workspace_count > 0
    environment: ${{ startsWith(matrix.workspace, 'platform/') && 'azure-tf-apply-platform' || 'azure-tf-apply-landingzone' }}
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix: ${{ fromJson(needs.detect-workspaces.outputs.workspace_matrix) }}
      fail-fast: false
    env:
      TF_VAR_entra_tenant_id: ${{ secrets.ARM_TENANT_ID }}
      TF_VAR_subscription_id_foundation: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}
      TF_VAR_subscription_id_mapping_json: ${{ secrets.ARM_SUBSCRIPTION_ID_MAPPING_JSON }}
      TF_VAR_storage_account_name_mapping_json: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME_MAPPING_JSON }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Mask sensitive values in logs
        uses: ./.github/actions/mask-azure-secrets
        with:
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id-foundation: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}
          tfstate-storage-account-name: ${{ secrets.ARM_TFSTATE_STORAGE_ACCOUNT_NAME }}
          subscription-id-mapping-json: ${{ secrets.ARM_SUBSCRIPTION_ID_MAPPING_JSON }}
          storage-account-name-mapping-json: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME_MAPPING_JSON }}

      - name: Azure Login via OIDC
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ startsWith(matrix.workspace, 'platform/') && secrets.ARM_CLIENT_ID_SP_GHA_TF_APPLY_PLATFORM || secrets.ARM_CLIENT_ID_SP_GHA_TF_APPLY_LANDINGZONE }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@e95ccdd20623115bfd7d47df14a3250d6066a9d0 # v1.0.7
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: Download Plan Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: tfplan-${{ matrix.workspace }}
          path: azure/tf/${{ matrix.workspace }}

      - name: OpenTofu Init
        working-directory: azure/tf/${{ matrix.workspace }}
        run: tofu init -backend-config="storage_account_name=$TFSTATE_STORAGE_ACCOUNT"
        env:
          TFSTATE_STORAGE_ACCOUNT: ${{ secrets.ARM_TFSTATE_STORAGE_ACCOUNT_NAME }}

      - name: OpenTofu Apply
        working-directory: azure/tf/${{ matrix.workspace }}
        run: tofu apply -auto-approve tfplan

  # =============================================================================
  # SENTINEL: Always report a final status for branch protection
  # =============================================================================
  sentinel:
    name: "OpenTofu Status"
    runs-on: ubuntu-latest
    if: always()
    needs: [detect-changes, detect-workspaces, validate, plan, apply]
    steps:
      - name: Decide final status
        run: |
          set -euo pipefail

          TERRAFORM="${{ needs.detect-changes.outputs.terraform }}"

          if [[ "${TERRAFORM}" != "true" ]]; then
            echo "No terraform changes detected -> PASS"
            exit 0
          fi

          # If terraform==true but there are no workspaces, treat as PASS
          WORKSPACE_COUNT="${{ needs.detect-workspaces.outputs.workspace_count }}"
          if [[ -z "${WORKSPACE_COUNT}" || "${WORKSPACE_COUNT}" == "0" ]]; then
            echo "Terraform flag true but no workspaces detected -> PASS"
            exit 0
          fi

          echo "Terraform changes detected -> evaluating job results"

          if [[ "${{ needs.detect-workspaces.result }}" != "success" ]]; then
            echo "::error::detect-workspaces did not succeed: ${{ needs.detect-workspaces.result }}"
            exit 1
          fi

          if [[ "${{ needs.validate.result }}" != "success" ]]; then
            echo "::error::validate did not succeed: ${{ needs.validate.result }}"
            exit 1
          fi

          EVENT="${{ github.event_name }}"
          if [[ "${EVENT}" == "pull_request" ]]; then
            if [[ "${{ needs.plan.result }}" != "success" ]]; then
              echo "::error::plan did not succeed: ${{ needs.plan.result }}"
              exit 1
            fi
          elif [[ "${EVENT}" == "push" ]]; then
            if [[ "${{ needs.apply.result }}" != "success" ]]; then
              echo "::error::apply did not succeed: ${{ needs.apply.result }}"
              exit 1
            fi
          fi

          echo "All required jobs succeeded -> PASS"
