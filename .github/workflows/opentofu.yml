# Infrastructure as Code Pipeline for Coruscant Project
#
# This workflow implements security-first OpenTofu practices with:
# - Multi-directory workspace isolation (one workspace per PR enforcement)
# - Comprehensive security scanning (Trivy IaC)
# - Azure OIDC authentication (no long-lived secrets)
# - Two-credential strategy (read-only for PRs, admin for main branch)
# - GitOps approval model (PR approval = infrastructure approval)
# - Plan artifact persistence and verification
#
# Why OpenTofu?
# - True open-source (MPL 2.0 license vs Terraform's restrictive BSL)
# - Native state encryption feature
# - Linux Foundation backed, community-driven
# - 100% compatible drop-in replacement for Terraform
# - No vendor lock-in
#
# Workspace Strategy:
# - Each directory under azure/tf/platform/* and azure/tf/landingzone/* is an independent workspace
# - PRs can only modify one workspace at a time (enforced)
# - Each workspace maintains separate state files
#
# Security Model:
# - Read-only credentials (repository secrets): PRs can plan
# - Admin credentials (environment secrets): Main branch can plan and apply
# - Environment 'azure-tf-plan' for PR plans (read-only)
# - Environment 'azure-tf-apply' for main branch plans and applies (admin)
# - Malicious branches cannot access admin credentials
#
# Approval Model (GitOps):
# - PR review = infrastructure approval (reviewers examine plan output)
# - Apply runs automatically after merge to main using plan artifact from plan job
# - Deletions handled same as additions (remove from .tf files, not via destroy)
#
# Pipeline Phases:
# Phase 1: Validation (all branches with terraform changes)
# Phase 2: Plan Generation (all branches, read-only for PRs, admin for main, saves plan artifact)
# Phase 3: Apply (main branch push only, uses saved plan artifact from Phase 2)
#
# Plan Artifact Strategy:
# - Plan job saves tfplan artifact (retention: 5 days)
# - Apply job downloads and uses saved plan artifact
# - Ensures what was reviewed in PR is exactly what gets applied
#
# Note: Drift detection runs in separate workflow (opentofu-scheduled.yml)

name: "OpenTofu"

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions: {}

env:
  TOFU_VERSION: "1.11.2"
  ARM_USE_OIDC: "true"

jobs:
  # =============================================================================
  # DETECT CHANGED FILES FOR CONDITIONAL EXECUTION
  # =============================================================================
  detect-changes:
    name: "Detect Changed Files"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    outputs:
      terraform: ${{ steps.filter.outputs.terraform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Detect changed file types
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            terraform:
              - 'azure/tf/governance/*.tf'
              - 'azure/tf/platform/**/*.tf'
              - 'azure/tf/landingzone/**/*.tf'
              - '.github/workflows/opentofu.yml'

  # =============================================================================
  # DETECT CHANGED WORKSPACES & ENFORCE SINGLE-WORKSPACE RULE
  # =============================================================================
  detect-workspaces:
    name: "Detect Changed Workspaces"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect-changes]
    if: needs.detect-changes.outputs.terraform == 'true'
    permissions:
      contents: read
      pull-requests: write
    outputs:
      workspace_count: ${{ steps.detect.outputs.workspace_count }}
      workspace: ${{ steps.detect.outputs.workspace }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0 # Need full history to diff against base branch

      - name: Derive changed workspaces
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          # Determine base and head refs for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
          else
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.sha }}"
          fi

          echo "Comparing $BASE_REF...$HEAD_REF"

          # Get changed files (including deletions - we filter deleted workspaces later)
          # A = Added, M = Modified, R = Renamed, D = Deleted
          CHANGED_FILES=$(git diff --name-only --diff-filter=AMRD "$BASE_REF" "$HEAD_REF" -- \
            azure/tf/governance \
            azure/tf/platform \
            azure/tf/landingzone || true)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # ------------------------------------------------------------
          # HARD EXIT: no terraform changes
          # ------------------------------------------------------------
          if [[ -z "${CHANGED_FILES}" ]]; then
            echo "No Terraform files changed -> skipping workspace detection"
            echo "workspace=" >> "$GITHUB_OUTPUT"
            echo 'workspaces_raw=' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # ------------------------------------------------------------
          # Derive workspaces from changed files
          # ------------------------------------------------------------
          WORKSPACES_RAW=$(printf '%s\n' "$CHANGED_FILES" | \
            awk -F/ '
              $1 == "azure" && $2 == "tf" {
                if ($3 == "governance") {
                  print "governance"
                }
                else if ($3 == "platform" && NF >= 6) {
                  print "platform/" $4 "/" $5
                }
                else if ($3 == "landingzone" && NF >= 5) {
                  print "landingzone/" $4
                }
              }
            ' | sort -u)

          # ------------------------------------------------------------
          # Filter out deleted workspaces (directory no longer exists)
          # ------------------------------------------------------------
          WORKSPACES=""
          while IFS= read -r ws; do
            [[ -z "$ws" ]] && continue
            WORKSPACE_PATH="azure/tf/$ws"
            if [[ -d "$WORKSPACE_PATH" ]]; then
              WORKSPACES="${WORKSPACES}${ws}"$'\n'
            else
              echo "Skipping deleted workspace: $ws (directory does not exist)"
            fi
          done <<< "$WORKSPACES_RAW"

          # Remove trailing newline
          WORKSPACES=$(echo -n "$WORKSPACES")

          echo "Detected workspaces (raw):"
          echo "$WORKSPACES"

          # ------------------------------------------------------------
          # Build outputs
          # ------------------------------------------------------------
          if [[ -z "$WORKSPACES" ]]; then
            WORKSPACE=""
            WORKSPACE_COUNT=0
          else
            WORKSPACE=$(echo "$WORKSPACES" | head -n 1)
            WORKSPACE_COUNT=$(echo "$WORKSPACES" | wc -l | tr -d ' ')
          fi

          echo "Detected workspace: $WORKSPACE"
          echo "workspace_count=$WORKSPACE_COUNT" >> "$GITHUB_OUTPUT"
          echo "workspace=$WORKSPACE" >> "$GITHUB_OUTPUT"

      - name: Enforce single workspace per PR
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          if [[ ${WORKSPACE_COUNT} -gt 1 ]]; then
            echo "::error::PR modifies multiple workspaces"
            gh pr comment "$PR_NUMBER" --body "## ⚠️ Multiple Workspaces Detected

            This PR modifies multiple workspaces

            Please split into one workspace per PR."
            exit 1
          else
            echo "Single workspace detected. Continuing..."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WORKSPACE_COUNT: ${{ steps.detect.outputs.workspaces_count }}

  # =============================================================================
  # PHASE 1: VALIDATION
  # =============================================================================
  validate:
    name: "Validate (${{ needs.detect-workspaces.outputs.workspace }})"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-changes, detect-workspaces]
    if: ${{ !failure() && !cancelled() && needs.detect-changes.outputs.terraform == 'true' && needs.detect-workspaces.outputs.workspace != '' }}
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: azure/tf/${{ needs.detect-workspaces.outputs.workspace }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@e95ccdd20623115bfd7d47df14a3250d6066a9d0 # v1.0.7
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: OpenTofu Format Check
        run: tofu fmt -check -recursive

      - name: OpenTofu Init
        run: tofu init -backend=false

      - name: OpenTofu Validate
        run: tofu validate

  # =============================================================================
  # PHASE 2: PLAN
  # =============================================================================
  plan:
    name: "Plan (${{ needs.detect-workspaces.outputs.workspace }})"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes, detect-workspaces, validate]
    if: ${{ !failure() && !cancelled() && needs.detect-changes.outputs.terraform == 'true' && needs.detect-workspaces.outputs.workspace != '' }}
    environment: azure-tf-plan
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    env:
      TF_VAR_entra_tenant_id: ${{ secrets.ARM_TENANT_ID }}
      TF_VAR_subscription_id_foundation: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}
      TF_VAR_subscription_id_mapping_json: ${{ secrets.ARM_SUBSCRIPTION_ID_MAPPING_JSON }}
      TF_VAR_storage_account_name_mapping_json: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME_MAPPING_JSON }}
      TF_VAR_storage_account_prefix: ${{ secrets.ARM_STORAGE_ACCOUNT_PREFIX }}
    defaults:
      run:
        working-directory: azure/tf/${{ needs.detect-workspaces.outputs.workspace }}
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Mask sensitive values in logs
        uses: ./.github/actions/mask-azure-secrets
        with:
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id-foundation: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}
          tfstate-storage-account-name: ${{ secrets.ARM_TFSTATE_STORAGE_ACCOUNT_NAME }}
          subscription-id-mapping-json: ${{ secrets.ARM_SUBSCRIPTION_ID_MAPPING_JSON }}
          storage-account-name-mapping-json: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME_MAPPING_JSON }}

      - name: Azure Login via OIDC
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }} # The env will set the client ID to the correct SP
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@e95ccdd20623115bfd7d47df14a3250d6066a9d0 # v1.0.7
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: OpenTofu Init
        run: tofu init ${{ github.event_name == 'pull_request' && '-lock=false' || '' }} -backend-config="storage_account_name=$TFSTATE_STORAGE_ACCOUNT"
        env:
          TFSTATE_STORAGE_ACCOUNT: ${{ secrets.ARM_TFSTATE_STORAGE_ACCOUNT_NAME }}

      - name: OpenTofu Plan
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          # Run plan and capture the detailed exit code safely.
          set +e
          tofu plan ${{ github.event_name == 'pull_request' && '-lock=false' || '' }} -out=tfplan -detailed-exitcode
          CODE=$?
          set -e

          echo "code=$CODE" >> "$GITHUB_OUTPUT"

          # Exit codes: 0 = no changes, 1 = error, 2 = changes present
          if [[ "$CODE" -eq 1 ]]; then
            echo "::error::OpenTofu plan failed"
            exit 1
          elif [[ "$CODE" -eq 2 ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Plan Artifact
        if: steps.plan.outputs.has_changes == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: tfplan
          path: azure/tf/${{ needs.detect-workspaces.outputs.workspace }}/tfplan
          retention-days: 1
          if-no-files-found: error

      - name: Generate Plan Summary
        if: github.event_name == 'pull_request' && steps.plan.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail

          {
            echo "## OpenTofu Plan: $WORKSPACE"
            echo ""
            echo "\`\`\`"
            tofu show -no-color tfplan | head -c 60000
            echo "\`\`\`"
          } > plan-summary.md
        env:
          WORKSPACE: ${{ needs.detect-workspaces.outputs.workspace }}

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request' && steps.plan.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail

          # Find existing comment by this workflow for this workspace
          COMMENT_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            --jq ".[] | select(.user.login == \"github-actions[bot]\" and (.body | startswith(\"## OpenTofu Plan: $WORKSPACE\"))) | .id" \
            | head -n 1)

          PLAN_BODY=$(cat plan-summary.md)

          if [[ -n "$COMMENT_ID" ]]; then
            # Update existing comment
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
              -f body="$PLAN_BODY"
            echo "Updated existing comment ID: $COMMENT_ID for workspace: $WORKSPACE"
          else
            # Create new comment
            gh pr comment "$PR_NUMBER" --body-file plan-summary.md
            echo "Created new comment for workspace: $WORKSPACE"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WORKSPACE: ${{ needs.detect-workspaces.outputs.workspace }}

  # =============================================================================
  # PHASE 3: APPLY
  # =============================================================================
  apply:
    name: "Apply (${{ needs.detect-workspaces.outputs.workspace }})"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [detect-changes, detect-workspaces, validate, plan]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      !failure() && !cancelled() &&
      needs.detect-changes.outputs.terraform == 'true' &&
      needs.detect-workspaces.outputs.workspace != '' &&
      needs.plan.outputs.has_changes == 'true'
    environment: ${{ needs.detect-workspaces.outputs.workspace == 'governance' && 'azure-tf-apply-governance' || (startsWith(needs.detect-workspaces.outputs.workspace, 'platform/') && 'azure-tf-apply-platform' || 'azure-tf-apply-landingzone') }}
    permissions:
      contents: read
      id-token: write
    env:
      TF_VAR_entra_tenant_id: ${{ secrets.ARM_TENANT_ID }}
      TF_VAR_subscription_id_foundation: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}
      TF_VAR_subscription_id_mapping_json: ${{ secrets.ARM_SUBSCRIPTION_ID_MAPPING_JSON }}
      TF_VAR_storage_account_name_mapping_json: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME_MAPPING_JSON }}
      TF_VAR_storage_account_prefix: ${{ secrets.ARM_STORAGE_ACCOUNT_PREFIX }}
    defaults:
      run:
        working-directory: azure/tf/${{ needs.detect-workspaces.outputs.workspace }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Mask sensitive values in logs
        uses: ./.github/actions/mask-azure-secrets
        with:
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id-foundation: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}
          tfstate-storage-account-name: ${{ secrets.ARM_TFSTATE_STORAGE_ACCOUNT_NAME }}
          subscription-id-mapping-json: ${{ secrets.ARM_SUBSCRIPTION_ID_MAPPING_JSON }}
          storage-account-name-mapping-json: ${{ secrets.ARM_STORAGE_ACCOUNT_NAME_MAPPING_JSON }}

      - name: Azure Login via OIDC
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }} # The env will set the client ID to the correct SP
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID_FOUNDATION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@e95ccdd20623115bfd7d47df14a3250d6066a9d0 # v1.0.7
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: Download Plan Artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: tfplan
          path: azure/tf/${{ needs.detect-workspaces.outputs.workspace }}

      - name: OpenTofu Init
        run: tofu init -backend-config="storage_account_name=$TFSTATE_STORAGE_ACCOUNT"
        env:
          TFSTATE_STORAGE_ACCOUNT: ${{ secrets.ARM_TFSTATE_STORAGE_ACCOUNT_NAME }}

      - name: OpenTofu Apply
        run: tofu apply -auto-approve tfplan

  # =============================================================================
  # SENTINEL: Always report a final status for branch protection
  # =============================================================================
  sentinel:
    name: "OpenTofu Status"
    runs-on: ubuntu-latest
    if: always()
    needs: [detect-changes, detect-workspaces, validate, plan, apply]
    steps:
      - name: Decide final status
        run: |
          set -euo pipefail

          TERRAFORM="${{ needs.detect-changes.outputs.terraform }}"
          if [[ "${TERRAFORM}" != "true" ]]; then
            echo "No terraform changes detected -> PASS"
            exit 0
          fi

          # If terraform==true but there are no workspaces, treat as PASS
          WORKSPACE="${{ needs.detect-workspaces.outputs.workspace }}"
          if [[ -z "$WORKSPACE" ]]; then
            echo "Terraform flag true but no workspace detected -> PASS"
            exit 0
          fi

          echo "Terraform changes detected -> evaluating job results"

          if [[ "${{ needs.validate.result }}" != "success" ]]; then
            echo "::error::validate did not succeed: ${{ needs.validate.result }}"
          fi
